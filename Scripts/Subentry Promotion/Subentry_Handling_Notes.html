<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
	<title>Subentry Handling notes</title>
	<meta name='Generator' content='Zim 0.65'>
	<style type='text/css'>
		a          { text-decoration: none      }
		a:hover    { text-decoration: underline }
		a:active   { text-decoration: underline }
		strike     { color: grey                }
		u          { text-decoration: none;
					 background-color: yellow   }
		tt         { color: #2e3436;            }
		pre        { color: #2e3436;
					 margin-left: 20px          }
		h1         { text-decoration: underline;
					 color: #4e9a06; margin-bottom: 0 }
		h2         { color: #4e9a06; margin-bottom: 0 }
		h3         { color: #4e9a06; margin-bottom: 0 }
		h4         { color: #4e9a06; margin-bottom: 0 }
		h5         { color: #4e9a06; margin-bottom: 0 }
		p          { margin-top: 0              }
		span.zim-tag {
			color: #ce5c00;
		}
		div.zim-object {
			border-style:solid;
			border-width:1px;
		}
		.checked-box {list-style-image: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAAXNSR0IArs4c6QAAAAZiS0dEAP8A/wD/oL2nkwAAAAlwSFlzAAANOgAADMQBiN+4gQAAAAd0SU1FB9gKGQ8sMEGsKGkAAAAZdEVYdENvbW1lbnQAQ3JlYXRlZCB3aXRoIEdJTVBXgQ4XAAAEBUlEQVRIx62V22tdRRTGf7Nn73P2ybntnNOe3NqkPTGgLTVUUZF6QatSLOKTPgqCIqLgQ0H/A1sQQbBYCBb1QfAxiC8tSO1FqHkwJVKtjdTGNraUmObsc9nXmfGh7cGYpM1D5nHWzPetteZb3wg2eB2YqYm4zSadsMtoboiNBH/3TE0awx6j+MRoxoTg/IYRvP19TQrJS0bzhdHGSyKFkLTtjSKwMjyiEz43ynhtP6bdjBCWyFobAf7eT7VhNF/q1FRbjYjmUohlCVPwnB+6FUxMTJipqSmUUhhjEGKd3bMT4ks/Y6oLBK2Yth8hHYtCJXOix7Nf7xLMzc0xOzvLzp078TyPNE3viW3QJPXzhNWbxFFKHCmMhoLn/FHodd48vGfhapdAacXQlkFK5dL6wIUm6fuTZPuvqDQhaMUYYyiVyuQr6rXDexYuAdi3tSv1ZJNs/R/CaszzT+1na88uXFnCEnJVgivBNN8uTJKmHQI/ptOOcXNZzMz9mOqFs90OHpipWcYwlo5P4ebnuOkrvr5wgrH+h3im7y36MzuwRXYZeKha/OhP0EkadFoxQSdGSotedR/+XwMc2XvKdNUFOFqZx6LKZWIiwjgkikNmLp/hm8sH+K1zjFTHXfBYdTi+eJArzXM0GxFxoBDCopLvo/fqEwi1XPkWkGqjFo2TgB1jOYZUKZTS/D1/ncmLh7jon0IbRWoiTi59ymzzJEEQE3cStNZsGxqlfPE57MBbOR8fP3hDGalOO9fq2DlBvmZw8xa2IxACGn6TydlD/O6f5OzSV/zif0cYhLQaEXGkKBbz7Ov/AOlXV1cxgBJRI3fuSTrpTawt18kWIZN1CFuaONI0w0WOXfsI43YIggh/KUSlhqxrMz74AkOZcWBm9QkH+Gw8NDLuITi+m0yzhluSyJzBLcpblUhFxywSRAEtPwQjsKVN30CNh0uvYuOubSHLtN3J0TO1j0pmBNuFbFWRK0gyPRZpktL2I5JQkclKakNlnh54g6ocvevUr/Ai2a7wineEkcJupA3S1Wg0nVZM2E6wbEF5U5G9Q++wI7sfR7h3N8HVNstykBfzH+KJEZwiWD0aIwxCgJ0R1Mu7GXOeJSuK93bZtQIle4D9pUNU5DC5jEsu55AvZakM5NicGyEj8uuz8bUCQgj67QfY671P3vEoeC69gy695U1U7NG7XV0pUwBjDJa1/JJlWWxzHuflzQe5FJ/GsgUVuZ2t8lEkTvfc0aNHb72flBhjVicQQqCUuvM3/M+WDVguWBrMVdDXEGZlBVEUrVCU9d9s5+fnaTQa2PZyPxEIhJaI1EEoZwX4ncynp6fXrmB4eJjR0VFarRbNZnP9P9rt9gohqNVq1Ov1ZbF/AZGev3hLJ2/zAAAAAElFTkSuQmCC)}
		.xchecked-box {list-style-image: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAAXNSR0IArs4c6QAAAAZiS0dEAP8A/wD/oL2nkwAAAAlwSFlzAAANOgAADMQBiN+4gQAAAAd0SU1FB9gKGQ8bDYnDxEwAAAAZdEVYdENvbW1lbnQAQ3JlYXRlZCB3aXRoIEdJTVBXgQ4XAAAEK0lEQVRIx9WVS2hTWRjHf/eR3CY1nbxMH2YiZRQS6qO13YlMVxY3SnVcuNIBFezGpSADLoQqLu1sHJCqdCFSXFpw4YOCSH3BtFqttTNamabX3DS5bfO6uffMoglja3RGcDMHzuac7/z/53++//cd+L8P6VuCPQYZ8ADNgBd4J31DcDcQs+GnHByRocEDv0kfBSjAOlYCs11Q+gpwDegS8LMJ+3QIK0ATzEhV8Odnz5bzw8P4dJ25aJQ/WlvJ1df/K7hSLtOcTNI+Pk69rpMTgqIQhCDvh1/VSpw79+gRrRMTmLZNezLJJsPg+a5dmOEwQlFqg1sWG16/Jv7sGWXDwBACFQjC9HcwIMONKkGp4PGAJGEDS0IQmZlhnWnye3c3eiyGo6qr3WHbrJ+dJf7gAXI6zSIr72T7/fgzmT4FHnTBsgrQBfYvTU0km5vxz86iADnAm0rRPTWFt7cXZccOJJcLAGHb2K9ekT93jmwmwwdAAFpjI6Ntbfxw5879ag7l6o1sr5eHHR3IsRgeQK/M4sQE+YEB7JcvEY6zAj45SWFgAPPxYwzHoQxIkQjTPT0kIxE+Noj8sexFn4/xnh58iQTeSpHkHAdrbIzi0BCOrmNPTpK/eJHM3bt8sCyKQCiR4NWePWSiUZw1+ZLXJm4pFKLhzBlCsRh2RUXacVgeGaF47RrL58+zcP8+RrmMkCQinZ1EL1zAjERqmkH+tLYl1G3bCJw4QUjT0IA0MJfLMX/5MqmHD0nZNiUgtGULG/r7ccXjINWuWbnmqsuFu7sb/4EDNLlcBIEioNs2KUAFGmMxmk6dQm1tRZI+3xBqEkiShBQOox05Ql1nJ26gvuIUAWiKQnj/ftStW5Fk+YuF+NldsbBA4cYN9KdPmaso8Fc62ZJtk7l1C2t0FGdxESHE1xE4hkHh6lX0oSHSpRIewC/LrPf7CSgKNpCamkI/fZr8pUuIZBIcpyaBunahPp1mub+fDyMjGKUSChCsq6Nh717q9u2jbnSU0uAgRrFIwTThyhUCqRS+hgZKLS1fJvDm87SNjZGcnsYUAjcQ8vsJ9/Xh7u1FDgRQN20iks3iDA+zZFmYhQLqzZtsj8WY3L0baY2Sf55ICCKpFHUzM2SEQAJCHg+hY8fQDh5EDgRWDoRC1J88SePRo2geD0XAcBy8b98Sv3ePYDZbbf2rFQjLIphMsmDbaEBQVQkePox26BCSz7e6i4bDrDt+nGYhmBscpFAskheC4Js3bPR4qHphFYEnlcI7P4/jdqNpGu8TCe4oCsXr1z//F2ga3+/cSfTJE0qmSVYIsKzaOZDcbjKyzFIiwfvt21kMBLA07YsetzWNd+3tLLW0sH5igvT8PH9Go/z44kX+E4LGjg7GDYOcy4XlOEgLC//5P/5LCFzxOPLmzWyIx+m6fduu7v0NVGqyTSycKksAAAAASUVORK5CYII=)}
		.unchecked-box {list-style-image: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAAXNSR0IArs4c6QAAAAZiS0dEAP8A/wD/oL2nkwAAAAlwSFlzAAANOgAADMQBiN+4gQAAAAd0SU1FB9gKGQ8qAt8h3m8AAAAZdEVYdENvbW1lbnQAQ3JlYXRlZCB3aXRoIEdJTVBXgQ4XAAAA60lEQVRIx+2VsQqDMBRF70sCLg5OLoKgjk7+lJ/hh+STXBwcnRz8ArMEkrxOFktbaC3tULzTg5e8k5vADXDq70VbobXmvu/hvQczg4heHrJfXxQFuq67blZbMc8zpmlCXddIkgTOuZcBUko45zCOI6y1Nz2xFSEEZFmGOI7fGg4A3nsQEZqmuXOu9jallACAtm3fvmutNaIoAjM/dkBECCF89KCbk4eAb+kEnIAT8EsAM0OIz3hSyrssUvss8t5fg+uIrLXPs0gIgWVZYIyBUurQyYdheO4gz3NUVQVjDNZ1PfSjpWmKsixvehfB9GBZ3NndrgAAAABJRU5ErkJggg==)}
		ul {list-style-image: none}
		/* ul rule needed to reset style for sub-bullets */
	</style>
</head>
<body>

<!-- Header -->
<div class='header'>
	[ <span class='insen'>Prev</span> ]

	[ <span class='insen'>Index</span> ]

	[ <a href='./Subentry_Handling_Notes_files/Sample_INI_File.html'>Next</a> ]
</div>

<hr />

<!-- Wiki content -->

<div class='pages'>
	<div class='heading'>
	<h1>Subentry Handling notes <a name='Subentry Handling Notes'></a></h1>
	</div>

	<div class='content'>
	<p>
Created Tuesday 15 November 2016<br>
Author: Wes Peacock<br>
Using Zim(v0.65) 
</p>

<h2>Pseudocode for hacking Variants in FW project</h2>

<br>

<h4>Why?</h4>

<p>
The current FieldWorks (v 8.3.1beta) SFM import assumes that all refences to other entries are variants. This process allows you to change that.
</p>

<h4>Preprocess</h4>

<p>
In FLex make a FW entry that looks the way you want your subentries to look. This can be a dummy entry that's deleted when you've changed the subentries. <br>
Somewhere in the Entry put some unique text.<br>
<div style='padding-left: 30pt'>
E.g., "*<b>Model Unspecified Complex Entry</b>*" in the Import Residue field
</div>
In the script this is called ModelTag. # It marks the lexical entry that has the model reference to another entry
</p>

<p>
In FLex, or the imported SFM file, or perl script that builds it, put a text into each sub-entry that will be changed into the Model type of Reference<br>
<div style='padding-left: 30pt'>
E.g. "<b>Complex_Form</b>" in the Import Residue field; \ve Complex_Form in the SFM file
</div>
In the script this is called ModifyTag. It marks all the entries that should be changed to the model
</p>

<p>
This script will find all the  Entries that contain the ModifyTag<br>
It will convert their references to their main entries so they are same type as the Model Entry.
</p>

<h4>Inputs with examples (see the ini file)</h4>

<p>
[hackFWvariants]<br>
modeltag="<b>Model Unspecified Complex Entry</b>"<br>
modifytag="<b>Complex_Form</b>"<br>
infilename=Nktest.fwdata<br>
outfilename=Nktest.new.fwdata
</p>

<h4>The script:</h4>

<p>
If InputProject + ".lock" exists:<br>
<div style='padding-left: 30pt'>
exit with a error "Don't run this script while FW is running"
</div>
Read &amp; Parse InputProject into an XML structure
</p>

<p>
Get the Owner of the ModelTag<br>
<div style='padding-left: 30pt'>
# Owner is the end of the trail of ownerguids until you reach a LexEntry or no more ownerguids
</div>
From the Owner <br>
<div style='padding-left: 30pt'>
Get the first guid  in the EntryRefs (xpath('./EntryRefs/objsur/@guid'))<br>
# This is the guid of the rt that will be used as a model<br>
That rt is the ModelLexEntryRef<br>
from the ModelLexEntryRef
</div>
<div style='padding-left: 60pt'>
save string versions of:
</div>
<div style='padding-left: 90pt'>
val attribute of HideMinorEntry that is ('./HideMinorEntry/@val');<br>
val attribute of RefType, that is: ('./RefType/@val');<br>
ComplexEntryTypes node ("./ComplexEntryTypes");
</div>
<div style='padding-left: 60pt'>
set modelHasAPrimaryLexeme flag if there's a PrimaryLexeme node<br>
set modelHasAShowComplexFormsIn flag if there's a ShowComplexFormsIn node<br>
# Are there other nodes to track?
</div>
</p>

<p>
ModifyList is a list of all the RTs that contain a ModifyTag<br>
<div style='padding-left: 30pt'>
# xpath   '<i>*[contains(., "</i>ModifyTag")//]/ancestor::rt'
</div>
foreach occurence in ModifyList:<br>
<div style='padding-left: 30pt'>
get the Owner of the ModifyTag<br>
the guid of EntryRef to modify is found at the xpath  './EntryRefs/objsur/@guid'
</div>
<div style='padding-left: 60pt'>
i.e. the first of the list EntryRef objsurs
</div>
<div style='padding-left: 30pt'>
If the EntryRef doesn't exist
</div>
<div style='padding-left: 60pt'>
print error message "This LexEnt doesn't refer to any other Lexents"<br>
go to next List item
</div>
<div style='padding-left: 30pt'>
In the rt of that EntryRef xpath '*<i>rt[@guid="</i>EntryRefguid//"]'
</div>
<div style='padding-left: 60pt'>
change the val attribute of the HideMinorEntry node to the val from the Model version<br>
change the val attribute of the RefType node to the val from the Model version<br>
Create a ComplexEntryTypes node from the Model ComplexEntryTypes string<br>
Get the guid from the ComponentLexemes/objsur node<br>
If modelHasAPrimaryLexeme create a PrimaryLexeme node<br>
If modelHasAShowComplexFormsIn create a ShowComplexFormsIn node<br>
Delete the VariantEntryTypes node if it exists
</div>
<div style='padding-left: 30pt'>
Log the Owner as having been changed.
</div>
</p>

<p>
Write the XML structure
</p>

<h2>End of Pseudocode</h2>

<br>
<br>

<h2>Other Notes:</h2>

<br>

<p>
You may need to install the Config::Tiny module if you get the error<br>
<div style='padding-left: 30pt'>
Can't locate Config/Tiny.pm in <span class="zim-tag">@INC</span> (you may need to install the Config::Tiny module)
</div>
At the shell:<br>
<div style='padding-left: 30pt'>
cpan install Config::Tiny
</div>
</p>

<p>
The script can be run multiple times with different models and modify tags<br>
<div style='padding-left: 30pt'>
E.g. a second run to fix up Phrasal Verbs:
</div>
<div style='padding-left: 60pt'>
[hackentrytypes]<br>
ModelTag="*<b>Model Phrasal Verb</b>*"<br>
ModifyTag="<b>Phrasal_Verb</b>"
</div>
</p>

<p>
Powershell doesn't like Unicode. If you don't don't redirect STDOUT:<br>
At the shell:<br>
<div style='padding-left: 30pt'>
chcp 65001
</div>
I doubt this will work for all complex alphabets YUMV: Your Unicode may vary.
</p>

<p>
Location of FLex database:<br>
<div style='padding-left: 30pt'>
C:\ProgramData\SIL\FieldWorks\Projects\Nktest\Nktest.fwdata
</div>
</p>

<br>

<h4>Code Snippets:</h4>

<p>
pythonic initial stuff (see below for installing lxml)<br>
from lxml import etree<br>
nktree = etree.parse('./Nktest.fwdata')<br>
def printrt( guid, tree = nktree):<br>
<div style='padding-left: 30pt'>
print(etree.tostring(nktree.xpath("//rt[starts-with(@guid, '" + guid + "')]")[0], pretty_print=True, encoding='unicode'))
</div>
</p>

<p>
perlish initial stuff — some of this stuff, particularly config stuff is expanded in the script<br>
<div style='padding-left: 30pt'>
# LibXML already included in Strawberry perl<br>
use 5.016;<br>
use strict;<br>
use warnings;<br>
use utf8;
</div>
</p>

<p>
<div style='padding-left: 30pt'>
use open qw/:std :utf8/;<br>
use XML::LibXML; # already included in Strawberry perl<br>
use Config::Tiny<br>
my $filename = 'Nktest.fwdata';<br>
my $nktree = XML::LibXML-&gt;load_xml(location =&gt; $filename);
</div>
</p>

<br>

<p>
Pythonic xpath of ownerguid:<br>
path = "//*[@guid='" + xguid + "']/@ownerguid"
</p>

<p>
Pythonic print the XML of the path variable:<br>
print(etree.tostring(nktree.xpath(path)[0], pretty_print=True, encoding='unicode'))
</p>

<p>
Pythonic path of guid for entry containing dzn by itself<br>
xguid = nktree.xpath("//rt[@class='MoStemAllomorph']/Form/AUni[text()='dzn']/../../@guid")[0]
</p>

<p>
python installing lxml<br>
<div style='padding-left: 30pt'>
from <a href="http://www.lfd.uci.edu/~gohlke/pythonlibs/#lxml" title="http://www.lfd.uci.edu/~gohlke/pythonlibs/#lxml" class="http">http://www.lfd.uci.edu/~gohlke/pythonlibs/#lxml</a> download: lxml‑3.6.4‑cp27‑cp27m‑win32.whl <br>
lxml‑3.6.4‑cp27‑cp27m‑win_amd64.whl   *** for py 2.7<br>
lxml‑3.6.4‑cp34‑cp34m‑win32.whl<br>
lxml‑3.6.4‑cp34‑cp34m‑win_amd64.whl<br>
lxml‑3.6.4‑cp35‑cp35m‑win32.whl<br>
lxml‑3.6.4‑cp35‑cp35m‑win_amd64.whl   *** for python 3.5<br>
lxml‑3.6.4‑cp36‑cp36m‑win32.whl<br>
lxml‑3.6.4‑cp36‑cp36m‑win_amd64.whl
</div>
then run <br>
<div style='padding-left: 30pt'>
pip2 .../lxml‑3.6.4‑cp27‑cp27m‑win_amd64.whl<br>
or<br>
pip3 .../lxml‑3.6.4‑cp35‑cp35m‑win_amd64.whl
</div>
</p>

<br>

<h2>Sample Files:</h2>

<p>
<a href="./Subentry_Handling_Notes_files/Sample_INI_File.html" title="+Sample INI File" class="page">+Sample INI File</a>
</p>

<p>
<a href="./Subentry_Handling_Notes_files/Sample_Model_LexEntryRef.html" title="+Sample Model LexEntryRef" class="page">+Sample Model LexEntryRef</a>
</p>

<p>
<a href="./Subentry_Handling_Notes_files/Sample_Modify_LexEntryRefs.html" title="+Sample Modify LexEntryRefs" class="page">+Sample Modify LexEntryRefs</a>
</p>

<p>
<a href="./Subentry_Handling_Notes_files/Sample_Rebuilt_LexEntryRef.html" title="+Sample Rebuilt LexEntryRef" class="page">+Sample Rebuilt LexEntryRef</a>
</p>

	</div>

	<br />

	<div class='page-footer'>

	</div>

	

</div>

</body>
</html>
